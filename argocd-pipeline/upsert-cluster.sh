#!/bin/bash

set -ea

kubectl version
helm version

# Install CRDs, ArgoCD
MANAGED_ARGOCD_VERSION=5.29.1

echo "Install/update CRDs"

# Install all CRDs for each app in the templates folder
for folder in ../environment-charts/managed-crds/argo ; do
  kubectl apply -f $folder
done

echo "Apply namespaces"
helm template ../environment-charts/managed-namespaces/ | kubectl apply -f -

echo "Install/update ArgoCD"
helm upgrade --version $MANAGED_ARGOCD_VERSION --install argocd ../environment-charts/managed-argocd/  -n argocd --skip-crds

echo "Install remote secrets for ArgoCD"
helm template ../files/cluster-secrets/ | kubectl apply -f -



apiVersion: v1
kind: Config
current-context: minikube
contexts:
- name: minikube
  context:
    cluster: minikube
    user: devops-cluster-admin
clusters:
- name: minikube
  cluster:
    certificate-authority-data:  LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCakNDQWU2Z0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwdGFXNXAKYTNWaVpVTkJNQjRYRFRJek1EVXdNekExTlRjd01Gb1hEVE16TURVd01UQTFOVGN3TUZvd0ZURVRNQkVHQTFVRQpBeE1LYldsdWFXdDFZbVZEUVRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBT1dFCi9RL3JQcUMvUWtRL3BBSlNNczc3UTdVOHczZ0FuRDFIdDRoRFdSUUR0TmMwb1RPLzFWNUJaNmFrL1lROUg5eWsKS2plbnB2SGgrWStkSnVJbnVpNitaUmZ4KzVNK2lUcEQ2S2VzTml1YlEySVZGVWp6QU8yMkJaOEFBaHBEc0o4KwpjbFN2Q2U0a3JHUWcwWEcxbUxhYm5BRFFpSlh4OGJBS09ER00vNERvWVhoZWRNVXRpUVQ3RFczTFR2d3JsTENsCmVoUCsySTZyYmlyY1NyWHpvTFZUYkpRSHl1T2JPTmpTMFRpMUFEMEJwYzNRcEhXQXRDMUpqQ0tVbGJQMXFiYU0KNEpiZmp3NDdoS2RFUi92R2pvL2lFRG1nQitWZlpBUEhHa3BBWjBjcHlyUTA4SWxNNVFrYldVSGJ3bm5Ma0k3egp3aDk4Vk42QkJQZUFSOFd0N3NNQ0F3RUFBYU5oTUY4d0RnWURWUjBQQVFIL0JBUURBZ0trTUIwR0ExVWRKUVFXCk1CUUdDQ3NHQVFVRkJ3TUNCZ2dyQmdFRkJRY0RBVEFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQjBHQTFVZERnUVcKQkJSMXdrczZEUnNKQkdvWFdpZlVLb1ZTeURiaVVEQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFWZHM0aVhnSQpRWWZJOTZmWnpvdTNpT0hFd0pwV1dPcHpIV1FYbTl1cEpVZjlzQ0ZNMnB5RjVUN29FOFRSbXg5YXNCU0ZGVzdqCk9Yc3BHelNpcUVuQU5aSjlnMHdaUTNUeHZicVc3amhuenpFZ0pwTFBQUkgzRzZyNkVvV1RmMGxCL0FxQ3VUNncKc0hIMW5Zd0NmaEl2U1FoQVdvYlZJZUV3Uk1ZbUh2eEw5NEZQSm9NQ0dkM0IwUXRKK1J4TFZpSFoyMVJoTVBSQgpna3R2Yk45K2VlVmZkUjNpSmt5YXRRR2dFQy9jbUhoeGo0T3UyRzRXV0lucWJ1R2lOZDdTNWlLdXE2cHJReUNCClhkL1UxRm1pU1dsS3R0ZmZZUFRLaGd1WXYrby9kR3Q0QUNTQmgrellWeHY5UytjQjg3Q283S0xIYi8rajZseDMKMng5QW4vYjlFbUlCaHc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    server: https://3.236.251.81:8443
users:
- name: devops-cluster-admin
  user:
    token: eyJhbGciOiJSUzI1NiIsImtpZCI6ImZLV0dQRGJ1ajVWWGRFb1lkOUw2WnpRYmY5Z0JEZHBLTmI4bElWRGNqeWMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkZXZvcHMtY2x1c3Rlci1hZG1pbmlzdHJhdG9yLXRva2VuLXJmN3ZuIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImRldm9wcy1jbHVzdGVyLWFkbWluaXN0cmF0b3IiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJlZGEwYzQ1OS0wZTc4LTRkOTgtODk3Zi05MDM3MzVkODg4NzUiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06ZGV2b3BzLWNsdXN0ZXItYWRtaW5pc3RyYXRvciJ9.QjCg9GTDDQkmY8iRJeiDS0s5_BOARRfSTX-fduPzKkvSHfY-h51SDI54f6yXMSIW_--ZepSK_PfwQcqsyhlYORkwmkLTq0Dn4DDjDhL2lUqU25hOjMIRX9U8jvU3Hl8y09unBe_sJ4Gcl1s5lbfuavPbLmrJukQaHFkAT_sGPl7mGE--voH4m_86oWMEFB-6Ez_hyCOE5vAvJMmlV0iQTHWR-S-D3R_m7fNwSRGazPXeoBg_cvLR-QQUYhrCFzfbDGJkWAbXGL-qK7X8dZsXaC1o7uykWb8H8OT205-K1IAoM8t8iLO9Qgd0zfLGY8_CltDwjimHyATwiuP4NsTueg
